#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω—ã –ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã (1 ‚Äî –ø—É—Ç—å –∫ –±–∏–Ω–∞—Ä–Ω–∏–∫—É, 2 ‚Äî –ø—É—Ç—å –∫ —Ç–µ—Å—Ç–∞–º)
if [ $# -lt 2 ]; then
    echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <–ø—É—Ç—å_–∫_–±–∏–Ω–∞—Ä–Ω–∏–∫—É> <–ø—É—Ç—å_–∫_–ø–∞–ø–∫–µ_—Å_—Ç–µ—Å—Ç–∞–º–∏>"
    exit 1
fi

binary="$1"        # –ü—É—Ç—å –∫ –±–∏–Ω–∞—Ä–Ω–∏–∫—É
data_dir="$2"      # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å —Ç–µ—Å—Ç–∞–º–∏
epsilon=0.0001     # –ü–æ—Ä–æ–≥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

if [ ! -d "$data_dir" ]; then
    echo "‚ùå –ü–∞–ø–∫–∞ $data_dir –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

files=("$data_dir"/*.in)

if [ ${#files[@]} -eq 0 ] || [ "${files[0]}" == "$data_dir/*.in" ]; then
    echo "‚ùå –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .in –≤ –ø–∞–ø–∫–µ $data_dir."
    exit 1
fi

for file in "${files[@]}"; do 
    base_name=$(basename "$file" .in)  # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    expected_file="$data_dir/$base_name.out"  # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É .out

    echo "üìÇ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: $file"

    if [ ! -f "$expected_file" ]; then
        echo "‚ùå –§–∞–π–ª —Å –æ–∂–∏–¥–∞–µ–º—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º ($expected_file) –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi

    echo "üî¢ –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å –º–∞—Ç—Ä–∏—Ü—ã:"
    result=$("$binary" < "$file")  # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    expected=$(cat "$expected_file")  # –ß–∏—Ç–∞–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

    echo "üîπ –†–µ–∑—É–ª—å—Ç–∞—Ç: $result"
    echo "üîπ –û–∂–∏–¥–∞–ª–æ—Å—å: $expected"

    # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–∑–Ω–∏—Ü—ã –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å epsilon
    difference=$(awk -v r="$result" -v e="$expected" 'BEGIN { print (r - e) < 0 ? -(r - e) : (r - e) }')

    if (( $(echo "$difference < $epsilon" | bc -l) )); then
        echo "‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!"
    else
        echo "‚ùå –û—à–∏–±–∫–∞! –†–∞–∑–Ω–∏—Ü–∞ $difference –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥ $epsilon."
        exit 1
    fi
    echo "-----------------------------------"
done
